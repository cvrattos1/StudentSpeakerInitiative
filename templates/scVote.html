<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie-edge">
<!--         <script src="./static/script.js" defer></script>
        <link href="./static/styles.css" rel="stylesheet"> -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/cloudinary-core/2.3.0/cloudinary-core-shrinkwrap.min.js"></script>
        <title>Students' Speaker Initiative</title>
	</head>
    <body class="bg-light">
        {% include 'sHeader.html' %}
        <style>
            .card-img-top {
                width: 100%;
                height: 18rem;
                object-fit: cover;
            }
        </style>
        <div class="container-fluid text-center">
            <br>
                {% if cycle.getName() %}
                    {% if validation['nominating'] or validation['endorsing'] %}
                            <hr><br><h3>The voting cycle will begin on {{ cycle.getDateVoting() }}.</h3><br><hr>
                    {% elif validation['voting'] %}
                        {% if hasvoted %}
                            <hr><br><h3>Thank you for voting. Come back on {{ cycle.getDateEnd()}} to see the results.</h3><br><hr>
                        {% else %}
                            <h4>These are the current conversation panels. The voting period ends on {{ cycle.getDateEnd()}}. You have this many votes: {{cycle.getVoteNum()}}. </h4><hr>
                            <form action="ccvote_flask" method= "post" name= "ccvote_form" id="ccvote_form">
                                        {%for conversation in conversations: %}
                                            	<div class="card text-center" style="border-width: thin; border-color: #F58025">
                                            		<div class="card-header"><h3 class="card-title text-center font-italic">Conversation Between:</h3></div>
                                                	<div class="card-body">
                                                		<div class="row text-center mx-auto justify-content-center">
                                                    	{% for speaker in conversation.getSpeakers() %}
                                                    	<div class="col-auto mx-auto mb-3">
	                                                    	<div class="card h-100" style="width: 18rem;">
	                                                    		<img data-src={{speaker[3]}} alt="" class="card-img-top cld-responsive">
		                                                    	<div class="card-body">
			                                                    	<h4 class="card-title font-weight-bold">{{speaker[0]}}</h4>
			                                                    	<p class="card-text"> Descripition: {{speaker[1]}} </p>
			                                                    	<a class="card-link" href=" {{speaker[2]}}" target="_blank"> Link to Works/Biography</a>
		                                                		</div>
		                                            		</div>
		                                            	</div>
                                                    	{% endfor %}
                                                		</div>
                                                	</div>
                                                    <div class="card-footer font-weight-bolder">
                                                        <input type="number" class="form-control text-center bg-white text-dark font-weight-bold" placeholder="Number of Votes" name="number" id={{conversation.getConverseId()}} min= 0>
                                                        <input type="hidden" name="converseid" value={{conversation.getConverseId()}}>
                                                    </div>
                                                </div>
                                            <br>
                                         {% endfor %}
                                         <br>
                                         {% if conversations|length > 0 %}
                                            <nav class="navbar navbar-expand-sm bg-dark navbar-dark fixed-bottom justify-content-center">
                                                <button type="button" class="voteButton btn bg-primary text-light font-weight-bold">Submit Votes</button>
                                            </nav>
                                            </form>
                                         {% else %}
                                         <h4> There are no candidates to vote for!</h4><br><hr>
                                         {% endif %}
                                    </div>
                                <br>
                        {% endif %}
                     {% elif validation['results'] %}
                        {% if conversations|length > 0 %}
                        <h4> Here are the results of the vote!</h4><hr>
                                {%for conversation in conversations: %}
                                    <div class="card text-center" style="border-width: thin; border-color: #F58025">
                                        <div class="card-header"><h3 class="card-title text-center font-italic">Conversation between:</h3></div>
                                        <div class="card-body">
                                            <div class="row text-center mx-auto justify-content-center">
                                            {% for speaker in conversation.getSpeakers() %}
                                                <div class="col-auto mx-auto mb-3">
                                                    <div class="card h-100" style="width: 18rem;">
                                                        <img data-src={{speaker[3]}} alt="" class="card-img-top cld-responsive">
                                                        <div class="card-body">
                                                            <h4 class="card-title font-weight-bold">{{speaker[0]}}</h4>
                                                            <p class="card-text"> Descripition: {{speaker[1]}} </p>
                                                            <a class="card-link" href=" {{speaker[2]}}" target="_blank"> Link to Works/Biography</a>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                            </div>
                                        </div>
                                        <div class="card-footer">
											<p class="card-text text-center font-weight-bold lead"> Received {{conversation.getVotes()}} vote(s).</p>
										</div>
                                    </div><br>
                                {% endfor %}
                        {% else %}
                        <hr><br><h3> Unfortunately, no conversations made it into the voting block. Please come back later to participate in selecting a conversation panel for our campus.</h3><br><hr> 
                        {% endif %}
                    {% else %}
                        <hr><br><h3> There is currently no active cycle. Please come back later to participate in selecting a conversation panel for our campus!</h3><br><hr>  
                    {% endif %}   
            {% else %}
                <hr><br><h3>There is no current cycle. Please come back later to participate in selecting a conversation panel for our campus! </h3><br><hr>
            {% endif %}   
        </div>

        <div class="modal" id="confirmModal">
            <div class="modal-dialog modal-dialog-scrollable">
                  <div class="modal-content">
                  
                    <!-- Modal Header -->
                    <div class="modal-header">
                        <h4 class="modal-title text-center">Confirm Votes</h4>
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                    </div>
                        
                        <!-- Modal body -->
                    <div class="modal-body text-center">
                        <p class="font-weight-bold"> You are about to vote for the following conversations: </p>
                        <p id="names" class="font-italic"></p>
                    </div>
                        <div class="modal-footer form-group justify-content-between">
                            <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel Submission</button>
                            <button type="button" class="submit btn btn-primary" name="submitVotes">Confirm Submission</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <script type="text/javascript">
            $(document.getElementById("scVote")).addClass("active");
            $(document.getElementById("navConvo")).addClass("active");

            let cl = cloudinary.Cloudinary.new({  cloud_name: '<Cloud Name>' });
            cl.responsive();
            
            let voteList = []

            let cycleName = '{{cycle.getName()}}';
            if (cycleName != '') {

                $(document).on("click", ".submit", function(e) {
                        if (voteList.length==0){
                            alert("You have not voted for any conversations.");
                            return false;
                        }
                        else {
                            // disable button
                          $(this).prop("disabled", true);
                          // add spinner to button
                          $(this).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Submitting...');
                          document.getElementById("ccvote_form").submit();
                        }

                });
                
                $(document).on("click", ".voteButton", function(e) {
                    if (Object.keys(voteList).length==0){
                        alert("You have not voted for any conversations.");
                    }
                    else {
                        $('#confirmModal').modal("show")
                        let namesArray = Object.values(voteList);

                        names = namesArray[0]
                        for (let i=1; i<namesArray.length; i++){
                            names += "<br>" + namesArray[i];
                        }

                        $("p[id='names']").html(names);
                    }

                });

                let voteForm = document.getElementById("ccvote_form");
                if (voteForm) {
                    let numgroup = document.getElementById("ccvote_form").elements.namedItem("number");
                    let limit='{{cycle.getVoteNum()}}';
                    if (limit != 'unlimited'){
                        $(document).on('change','input', function(){
                            let current = $(this).val();
                            let conversationid = this.id
                            let speakers = $(this).parent().parent().find('h4');

                            if (current == 0){
                                delete voteList[conversationid];
                            }
                            else if (current < 0){
                                $(this).val(0);
                                alert("A speaker cannot have a negative number of votes.")
                                delete voteList[conversationid];
                            }
                            else {
                                let names = "Conversation: " + $(speakers[0]).html();
                                for (let i=1; i<speakers.length; i++) {
                                    names += ", " + $(speakers[i]).html();
                                }

                                let numcount=0
                                for (let i=0; i<numgroup.length; i++)
                                    if ($(numgroup[i]).val()) {
                                        numcount += parseInt($(numgroup[i]).val());
                                    }
                                if (parseInt(numcount) > parseInt(limit)){
                                    let max = parseInt(limit) - (parseInt(numcount) - current);
                                    if (max > 0) 
                                        voteList[conversationid]=names;
                                    else {
                                        delete voteList[conversationid];
                                    }
                                    $(this).val(max);
                                    alert("You can only us a maximum of "+limit+" vote(s).")
                                }
                                else voteList[conversationid]=names;
                            }
                        });
                    }
                }
            }   
        </script>
    </body>
</html>